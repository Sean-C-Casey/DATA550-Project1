---
title: "Mini Project 1"
author: 'Justine Filion and Sean Casey'
date: "January 28 2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r eval=TRUE, echo=FALSE, include=FALSE}
#install.packages("dplyr")
library(dplyr)

#install.packages("knitr")
library(knitr)

#install.packages("devtools")
library(devtools)

#install.packages("DT")
library(DT)

#install.packages("xtable")
library(xtable)

library(tidyverse)

# install.packages('caret')
library(caret)

library(readxl)

library(ggplot2)

# install.packages('arulesCBA')
library(arulesCBA)
```

# Step 1 : Describe the Dataset

The data used in the following analysis was provided to us by the Department of Information Management from Chung Hua University and the Department of Civil Engineering from Tamkang University which are both located in Taiwan. It was donated as of January 26th 2016 but refers to data collected from April to September 2005. The purpose of this dataset is to provide insight on the relationship between different explanatory variables and the probability of default. It contains 23 explanatory variables, all of which are integers, as well as a response variable which takes a value of 1 if the client defaulted in the following month and 0 if not. This dataset was made available to us via the UCI Machine Learning Repository which can be accessed through this link : [link](https://archive.ics.uci.edu/ml/machine-learning-databases/00350/). 

# Step 2 : Load the Dataset

```{r}
df <- read_excel('defaultofcreditcardclients.xls', skip = 1)
```

# Step 3 : Explore the Dataset

```{r}
str(df)

summary(df)

sapply(3:5, function(x) table(df[,x])) # Sex, Education, Marriage

```
# Step 4 : Initial Thoughts

* Why are there 0, 5 and 6s for Education if supposed to be from 1 to 4 --> put them in 4 = others ?
* Why is there 0 for Marital status if supposed to be from 1 to 3 --> put it in 3 = others ?
* Make column to count the amount of times the client defaulted (evaluate how good/bad of a credit the client has)

# Step 5 : Wrangling

For the `Education` variable, the data description does not mention what 0, 5 and 6 represent. For our analysis, we chose to classify these values as others and so attributed them the value 4. We also thought it would be interesting to add a column that represented the number of months out of the 6 included in the data where the client defaulted. To do this, we calculated the number of months out of the 6 where a payment was delayed (values from 1 to 9 in columns PAY_SEP through PAY_APR). Another column called `REVOLVING_CREDIT` was added. It counts the number of months where a client was offered revolving credit. Finally, we decided to discretize the age variable. We created the following age intervals :  [20, 30), [30, 40), [40, 50), [50, 60), [60, 70), [70, 80) and [80, 90).


```{r}
df[df$EDUCATION %in% c(0, 5, 6), "EDUCATION"] <- 4

for (i in 1:nrow(df)){
  count = 0
  for (j in 7:12){
    if (df[i, j] > 0){
      count =  count + 1
    }
  }
  df[i, 'QTY_DEFAULT'] <- count
}

for (i in 1:nrow(df)){
  count = 0
  for (j in 7:12){
    if (df[i, j] == 0){
      count =  count + 1
    }
  }
  df[i, 'REVOLVING_CREDIT'] <- count
}



df$AGE <- cut(df$AGE, breaks = c(20, 30, 40, 50, 60, 70, 80, 90), include.lowest = TRUE)

```


# Step 6 : Research Questions

1- Are the people with a higher education (graduate school, university), on average, default less frequently than people with a lower level of education (high school)?

2- Are the people who are given higher amounts of credit, also people who, on average, default less frequently?

3- Are the people who are married, on average, default less frequently than people who are single? 

4- Are people who are given revolving credit also given a higher amount of credit?

5- Are people who are given revolving credit also tend to be people who are older? Married? 

6- Are people who have defaulted more than once in the past 6 months more likely to default in October (Y column)?
 

# Step 7 : Data Analysis & Visualizations
```{r}
ggplot(df) +
  aes(x = `QTY_DEFAULT`) +
  geom_histogram(binwidth = 1, fill = "dodgerblue4") +
  ggtitle("Occurences of Payment Default within a 6-month Period") +
  labs(x = "Payment Default Occurences", y = "Count") +
  theme_minimal()
```

```{r}
# aggregate(df$QTY_DEFAULT, by=list(df$EDUCATION), FUN=mean)
default_by_education  <- df %>% group_by(`EDUCATION`) %>% summarise(mean_default = mean(`QTY_DEFAULT`))
default_by_education$EDUCATION <- factor(
  default_by_education$EDUCATION, 
  levels = c(1, 2, 3, 4),
  labels = c("Graduate", "Undergraduate", "High School", "Other")
)

ggplot(default_by_education) +
  aes(x = reorder(`EDUCATION`, -`mean_default`), y = `mean_default`, fill = `EDUCATION`) +
  geom_bar(show.legend = FALSE, stat="identity", position="dodge") +
  geom_text(aes(label=sprintf("%.2f", `mean_default`)), position=position_dodge(width = 0.2), vjust=-0.5) +
  ggtitle("Mean Number of Payment Defaults by Education Level") +
  labs(x = "Education", y = "Mean default Count") +
  theme_minimal()
```


What is the distribution of education for the people that never defaulted over the 6 months in the data.

```{r}
no_default  <- df[df$QTY_DEFAULT == 0,]

no_default_education <- no_default %>% group_by(`EDUCATION`) %>% summarise(no_default = NROW(`EDUCATION`))

no_default_education <- cbind(no_default_education, table(df$EDUCATION))[-3]

no_default_education['mean'] <- no_default_education$no_default/no_default_education$Freq

no_default_education$EDUCATION <- factor(
  no_default_education$EDUCATION, 
  levels = c(1, 2, 3, 4),
  labels = c("Graduate", "Undergraduate", "High School", "Other")
)

ggplot(no_default_education) +
  aes(x = reorder(`EDUCATION`, -`mean`), y = `mean`, fill = `EDUCATION`) +
  geom_bar(show.legend = FALSE, stat="identity", position="dodge") +
  geom_text(aes(label=sprintf("%.1f%%", `mean`*100)), position=position_dodge(width = 0.2), vjust=-0.5) +
  ggtitle("Proportion of People with no Default by Education Level") +
  labs(x = "Education", y = "Proportion of people with no default") +
  theme_minimal()

```



2- Are the people who are given higher amounts of credit, also people who, on average, default less frequently?

```{r}

ggplot(df, aes(x = as.factor(QTY_DEFAULT), y = LIMIT_BAL, fill = as.factor(QTY_DEFAULT))) + geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) + labs(x = "Number of months where the account was in default", y = "Amount of Credit Given")  + guides(fill="none") + theme_minimal()

```


```{r}

new_df <- df %>% select(SEX, MARRIAGE, QTY_DEFAULT, EDUCATION, REVOLVING_CREDIT) %>%
                 rename(GENDER = SEX, MARITAL_STATUS = MARRIAGE)
GGally::ggcorr(new_df, label = TRUE, method = c('pairwise','spearman'), size = 2) 
```











# Not going to use plot



What is the distribution of 'marriage' for the people that never defaulted over the 6 months in the data.

```{r}
no_default  <- df[df$QTY_DEFAULT == 0,]

no_default_marriage <- no_default %>% group_by(`MARRIAGE`) %>% summarise(no_default = NROW(`MARRIAGE`))

no_default_marriage <- cbind(no_default_marriage, table(df$MARRIAGE))[-3]

no_default_marriage['mean'] <- round((no_default_marriage$no_default/no_default_marriage$Freq), 2)

no_default_marriage$MARRIAGE <- factor(
  no_default_marriage$MARRIAGE, 
  levels = c(0, 1, 2, 3),
  labels = c("Other", "Married", "Single", "Divorce")
)

ggplot(no_default_marriage) +
  aes(x = reorder(`MARRIAGE`, -`mean`), y = `mean`, fill = `MARRIAGE`) +
  geom_bar(show.legend = FALSE, stat="identity", position="dodge") +
  geom_text(aes(label=sprintf("%.2f", `mean`)), position=position_dodge(width = 0.2), vjust=-0.5) +
  ggtitle("Proportion of People with no Default by Marital Status") +
  labs(x = "Marital Status", y = "Proportion of people with no default") +
  theme_minimal()

```





```{r}
df2 <- df
df2$EDUCATION <- factor(
  df2$EDUCATION, 
  levels = c(1, 2, 3, 4),
  labels = c("Graduate", "Undergraduate", "High School", "Other")
)

ggplot(data = df2, aes(x = as.factor(QTY_DEFAULT))) + geom_bar(aes(fill=as.factor(EDUCATION), position="dodge")) + theme_minimal()

library(tidyverse)
df %>%
  group_by(as.factor(EDUCATION), QTY_DEFAULT) %>% #group by both variables
  summarise(n = n()) %>% #count members per group
  group_by(EDUCATION) %>% #group just by the fill variable
  mutate(y = n/sum(n)) %>% #percent of each QTY_DEFAULT n per EDUCATION group
  
  ggplot() +
  geom_col(aes(y=y, x = QTY_DEFAULT, fill = as.factor(EDUCATION)), position="dodge")+
  scale_y_continuous(labels=scales::percent_format())

```


```{r}

test <- df %>% group_by(EDUCATION, QTY_DEFAULT) %>% 
      add_count()
      
test2 <- test %>% group_by(EDUCATION) %>%
          add_count() %>%
          mutate(proportion = n/nn) 

ggplot(data = test2, aes(x = EDUCATION, y = QTY_DEFAULT)) + geom_point(aes(size=proportion, color=proportion)) + 
                                                                  guides(color = guide_legend(title = 'proportion'), size=guide_legend(title = 'proportion')) +
                                                                scale_color_continuous(limits=c(0, 1),  breaks=seq(0, 1, by=0.1)) +
                                                                scale_size_continuous(limits=c(0, 1), range = c(0,15), breaks=seq(0, 1, by=0.1)) + theme_bw()

```


6- Are people who have defaulted more than once in the past 6 months more likely to default in October (Y column)?
```{r}
GGally::ggally_cross(df, aes(x = as.factor(QTY_DEFAULT), y = as.factor(`default payment next month`), color = as.factor(`default payment next month`))) + theme_minimal()
```

# step 8 : Summary and Conclusions



















